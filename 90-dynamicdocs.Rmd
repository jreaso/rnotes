
# Dynamic Documents and Interactive Dashboards

## RMD

**Document Preamble**
```{r, eval=FALSE}
---
title: "Example"
author: "(optional) Jamie Reason"
date: "(optional)"
output:
  html_document: default
  pdf_document: default
---
```


[Course Slides on RMD](https://www.louisaslett.com/Courses/DSSC/slides/07_rmarkdown/07_rmarkdown.html#8)

For further formatting, refer to [RMD Cheat Sheet](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf)

## Shiny

**Resource:** [Mastering Shiny Book](https://mastering-shiny.org/index.html)

**Outline**

- **UI**
- **Server**

R code can be added to any part of a shiny document but only the code in the server will be updated when needed.


Starting a Shiny Dashboard (create a new shiny app in R studio):

*```fluidpage()``` is just the most common but there are alternatives*

```{r, eval = FALSE}
library(shiny)

#misc code

ui <- fluidpage(
  ...
)

server <- function(input, output, session){
  #server code
}

shinyApp(ui, server)
```

### UI

[UI elements reference guide](https://shiny.rstudio.com/reference/shiny/1.7.0/)

#### Pages

**Examples**
```{r, eval=FALSE}
ui <- fluidPage(
  "One",
  "Two",
  "Three"
)
shinyApp(ui, server = function(input, output, session) {})
```

```{r, eval=FALSE}
ui <- navbarPage(
  "Title of page",
  tabPanel("My first tab", "Hello Alice"),
  tabPanel("My second tab", "Hello Bob")
)
shinyApp(ui, server = function(input, output, session) {})
```

Other pages: ```fixedPage()```, ```fillPage()```, ...

#### Layouts and Panels

Goes inside of the page

- ```titlePanel("My App")```
- ```sidebarLayout()```
  - first argument ```sidebarPanel()```
  - second argument ```mainPanel()```
- ```fluidrow()``` - creates a new row with columns in
  - ```column() calls
    - first a number 1 to 12 (all columns numbers must sum to 12) for width
    -other arguments are outputs

**Examples**

```{r, eval=FALSE}
ui <- fluidPage(
  titlePanel("My App"),
  sidebarLayout(
    sidebarPanel("I'm in sidebar"),
    mainPanel("I'm in main panel")
  )
)
shinyApp(ui, server = function(input, output, session) {})
```

```{r, eval=FALSE}
ui <- fluidPage(
  fluidRow(
    column(4, "Lorem ipsum dolor ..."),
    column(8, "Lorem ipsum dolor ...")
  ),
  fluidRow(
    column(6, "Lorem ipsum dolor ..."),
    column(6, "Lorem ipsum dolor ...")
  )
)
shinyApp(ui, server = function(input, output, session) {})
```


#### UI Inputs

All inputs take same first argument - ```inputId```, the unique identifier of the input.

This can be accessed by using ```input$name``` (in the server).

The second argument is a label, or how it's name appears on the dashboard.

**Text Inputs**

- ```textInput()```
- ```passwordInput()```
- ```textAreaInput()```


**Numeric Inputs**

- ```numericInput()```
- ```sliderInput()```


**Categoric Inputs**

- ```selectInput()```
- ```radioButtons()```
- ```checkboxGroupInput()```

**Examples**


```{r, eval=FALSE}
ui <- fluidPage(
  numericInput("num", "Number one", value = 0, min = 0, max = 100),
  sliderInput("num2", "Number two", value = 50, min = 0, max = 100),
  sliderInput("rng", "Range", value = c(10, 20), min = 0, max = 100)
)
shinyApp(ui, server = function(input, output, session) {})
```

```{r, eval=FALSE}
animals <- c("dog", "cat", "mouse", "bird", "other", "I hate animals")
ui <- fluidPage(
  selectInput("state", "What's your favourite state?", state.name),
  radioButtons("animal", "What's your favourite animal?", animals),
  checkboxGroupInput("animal2", "What animals do you like?", animals)
)
shinyApp(ui, server = function(input, output, session) {})
```


### Server and UI Outputs

All outputs take same first argument, ```outputId``` and an output can be called by ```output$name```.

#### UI Outputs

**Text Outputs**

- ```textOutput()```
- ```renderText()```
- ```verbatimTextOutput()```
- ```renderPrint()```

**Plot Outputs**

- ```plotOutput()``` and ```renderPlot()```
  - ```width``` argument
  - ```res = 96``` argument closest to what you see inj RStudio




**Examples**

```{r, eval=FALSE}
ui <- fluidPage(
  textInput("name", "What's your name?"),
  textOutput("greet")
)
server <- function(input, output, session) {
  output$greet <- renderText({
    if(nchar(input$name) > 0) {
      return(paste0("Hello ", input$name))
    } else {
      return("Hello friend, tell me your name!")
    }
  })
}
shinyApp(ui, server)
```

```{r, eval=FALSE}
ui <- fluidPage(
  plotOutput("myplot", width = "400px")
)
server <- function(input, output, session) {
  output$myplot <- renderPlot({
    plot(iris$Sepal.Length, iris$Sepal.Width)
  }, res = 96)
}
shinyApp(ui, server)
```


#### Variables outside outputs (reactive)

Instead of making variables in the server (**which you can't do as they wouldn't be reactive**), you use the ```reactive({})``` call:

Inside the server,
```{r, eval=FALSE}
name <- ...
```
becomes,
```{r, eval=FALSE}
name <- reactive({
  ...
})
```
And when ```name``` is used it should be called as ```name()```

**Examples**

```{r, eval=FALSE}
server <- function(input, output, session) {
  name <- reactive({
    toupper(input$name)
  })
  output$greet <- renderText({
    if(nchar(input$name) > 0) {
      return(paste0("Hello ", name(), ", here is your plot ..."))
    } else {
      return("Hello friend, tell me your name!")
    }
  })
  output$myplot <- renderPlot({
    if(nchar(input$name) > 0) {
      ggplot(iris, aes_string(x = input$xvar, y = input$yvar)) +
        geom_point() +
        labs(title = paste0(name(), "'s plot!"))
    }
  }, res = 96)
}
```

### Full Example

From exercise 5.78 (Lab 8)

```{r, eval= FALSE}
library("shiny")
library("ukpolice")
library("tidyverse")
library("leaflet")

nbd <- ukc_neighbourhoods("durham")
nbd2 <- nbd$id
names(nbd2) <- nbd$name

# Define UI for application
ui <- fluidPage(
  titlePanel("UK Police Data"),
  sidebarLayout(
    sidebarPanel(
      selectInput("nbd", "Choose Durham Constabulary Neighborhood", nbd2),
      textInput("date", "Enter the desired year and month in the format YYYY-MM", value = "2021-09")
    ),

    # Show a plot of the generated distribution
    mainPanel(
      plotOutput("barchart"),
      leafletOutput("map")
    )
  )
)

# Define server logic
server <- function(input, output) {
  # Get boundaries for selected neighbourhood
  # Wrapped in a reactive because we need this to trigger a
  # change when the input neighborhood changes
  bdy <- reactive({
    bdy <- ukc_neighbourhood_boundary("durham", input$nbd)
    bdy |>
      mutate(latitude = as.numeric(latitude),
             longitude = as.numeric(longitude))
  })

  # Get crimes for selected neighbourhood
  # Also wrapped in a reactive because we need this to trigger a
  # change when the boundary above, or date, changes
  crimes <- reactive({
    bdy2 <- bdy() |>
      select(lat = latitude,
             lng = longitude)

    ukc_crime_poly(bdy2[round(seq(1, nrow(bdy2), length.out = 100)), ], input$date)
  })

  # First do plot
  output$barchart <- renderPlot({
    ggplot(crimes()) +
      geom_bar(aes(y = category, fill = outcome_status_category)) +
      labs(y = "Crime", fill = "Outcome Status")
  }, res = 96)

  # Then do map
  output$map <- renderLeaflet({
    leaflet() |>
      addTiles() |>
      addPolygons(lng = bdy()$longitude, lat = bdy()$latitude) |>
      addCircles(lng = as.numeric(crimes()$longitude), lat = as.numeric(crimes()$latitude), label = crimes()$category, color = "red")
  })
}

# Run the application
```


