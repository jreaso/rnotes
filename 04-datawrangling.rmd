# Data Wrangling (using tidyverse)

Loading ```tidyverse```,
```{r, eval=FALSE}
library("tidyverse")
```



## Tidy Form (```tidyr```)

**What is tidy data?**

- each variable is in a column
- each observation is in a row
- each type of observational unit forms a table

### Moving to and from tidy data

**Problems** (how data may violate tidy form)

- Data is **too wide** - one variable spread over multiple columns (use ```pivot_longer()```)
- Data is **too long** - one observation spread along multiple rows (use ```pivot_wider()```)


**```pivot_longer()```**

Makes Wide Data Longer

The arguments are:

- Data Frame
- Columns to transform
- Name of the column where previous column names should go
- Name of the column where values from the column should go

**Example**
```{r, echo=FALSE, message=FALSE}
library("tidyverse")
who_wide <- data.frame(country = c("Afghanistan", "Brazil", "China"), y1999 = c(745, 37737, 212258), y2000 = c(2666, 80488, 213766))
```
```{r}
who_wide

pivot_longer(who_wide,
             c(`y1999`, `y2000`),
             names_to = "year",
             values_to = "cases")
```



**```pivot_wider()```**

Makes Long Data Wider

The arguments are:

- Data Frame
- Columns to transform
- Name of the column where column names should come from
- Name of the column where values should come from

**Example**
```{r, echo=FALSE, message=FALSE}
library("tidyverse")
who_long <- data.frame(country = c("Afghanistan", "Afghanistan", "Afghanistan", "Afghanistan", "Brazil", "Brazil", "Brazil", "Brazil", "China", "China", "China", "China"), year = c(1999,1999,2000,2000,1999,1999,2000,2000,1999,1999,2000,2000), type=c("cases","population","cases","population","cases","population","cases","population","cases","population","cases","population"), count = c(745, 19987071, 2666, 20595360, 37737, 172006362, 80488, 174504898, 212258, 1272915272, 213766, 1280428583))
```
```{r}
who_long

pivot_wider(who_long,
            names_from = "type",
            values_from = "count")
```



**Additional Example - DSSC Lab 5.6**
```{r, echo=FALSE, message=FALSE}
library("tidyverse")

pres.res <- data.frame(
  Candidate = c("Clinton", "Trump", "Other"),
  California = c("8753788/14181595", "4483810/14181595", "943997/14181595"),
  Arkansas = c("380494/1130676", "684872/1130676", "65310/1130676")
)
```
```{r}
pres.res


pres.res2 <- pivot_longer(pres.res,
                          c("California", "Arkansas"),
                          names_to = "State",
                          values_to = "Proportion")
pres.res2

pres.res3 <- separate(pres.res2, "Proportion", c("Votes", "Total"))
pres.res3

pres.res4 <- mutate(pres.res3, Votes = as.numeric(Votes), Total = as.numeric(Total))
str(pres.res4)

pres.res5 <- pres.res4 |> 
  group_by(Candidate) |> 
  summarise(Percent = sum(Votes)/sum(Total)*100) |> 
  arrange(desc(Percent))
pres.res5
```


### Other useful ```tidyr``` functions

- ```separate()``` -  splits one column of strings into multiple new columns
- ```unite()``` -  combines many columns into one (as a string)
- ```extract()``` - uses regular expressions to pull out specific information from a string column

**Example**
```{r, echo=FALSE, message=FALSE}
fball <- data.frame(home=c("Man U", "Tottenham", "Chelsea"), away=c("Shef Wed", "Arsenal", "W Ham"), score=c("2-1","0-0","1-0"))
```
```{r}
fball
separate(fball, "score", c("home_goals", "away_goals"))
```


## Data Manipulation (```dplyr```)

## Main ```dplyr``` functions

(First argument is always the data frame)

**```filter()```** - Focus on a subset of rows

Other Arguments

- condition to filter by

For example, ```filter(who, year == 1999)```

(*see above list of logical operators*)

**```arrange()```** - Reorder the rows

Other Arguments

- Variable names to sort by, sub-sorting by later variables
- Wrap variable name in ```desc()``` to sort descending (ascending by default)

For example, ```arrange(who, year, desc(country))```

**```select()```** - Focus on a subset of variables (columns)

Other Arguments

- Name of variables to retain

For example, ```select(who, year, cases)```

**```mutate()```** - Create new derived variables

Other Arguments

- Name of new variable and equation defining it

For example, ```mutate(who, rate = cases/population)```

**```group_by()```** - Splits a data frame up into groups according to one variable

Other Arguments

- Name of variable to group by

For example, ```group_by(who, country)```


**```summarise()```** - Create summary statistics (collapsing many rows) by groupings

Other Arguments

- Function to summarise by

For example, ```summarise(who, total = sum(cases))```

*Note: often want to summarise by group*

For example,
```{r, eval=FALSE}
who2 <- group_by(who, country)
summarise(who2, total = sum(cases), change = max(cases)-min(cases))
```

### Pipelines

Chain functions (not limited to tidyverse functions) where result of first function is first entry in second function and so on.

Example,
```{r eval=FALSE}
filter(x, ...) |> 
  select(...) |> 
  mutate(...) |> 
  group_by(...) |> 
  arrange(...)
```


**Pipeline Operator: CMD-SHIFT-M**

### Joining Data Frames (in tidyverse)

Simplest case of joining data frames (more details in data frames section):

- ```rbind()``` - paste rows together (above/below)
- ```cbind()``` -  paste cols together (left/right)

These methods can be very error prone (requires variables/observations in identical order etc)

#### Advanced Data Frame Joins

- ```left_join(x, y)``` - add new variables from y to x, keeping all x obs
- ```right_join(x, y)``` - add new variables from x to y, keeping all y obs
- ```inner_join(x, y)``` - keep only matching rows
- ```full_join(x, y)``` - keep all rows in both x and y

```{r pressure, echo=FALSE,  out.width = '40%', fig.align = 'center'}
knitr::include_graphics("https://www.louisaslett.com/Courses/DSSC/slides/06_ggplot2/i/joins.png")
```

**Example**

```{r echo=FALSE, message=FALSE}
library("tidyverse")

data("band_members", package = "dplyr")
data("band_instruments2", package = "dplyr")
```
```{r}
band_members
band_instruments2

left_join(band_members, band_instruments2, by = c("name" = "artist"))
```
